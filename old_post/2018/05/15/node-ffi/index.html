<!DOCTYPE html>

<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=0">

  <meta name="description" content="SpringHack的无名技术小站">


	<meta name="keywords" content="Dosk, SpringHack, Hacker">

<link rel="alternate" href="/atom.xml" title="Dosk技术站" type="application/atom+xml">
<meta name="theme-color" content="#5badf0">
<title>Node-FFI 不得不说的原理 - Dosk技术站</title>
<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
<link rel="shortcut icon" href="/favicon.png">
<link rel="stylesheet" href="/css/style.css">
<nav class="main-nav">
	
	    <a href="/">← Home</a>
	
	
	    <a href="/about/">About</a>
	
	    <a href="/archives/">Archives</a>
	
	<a class="cta" href="/atom.xml" data-no-instant>Subscribe</a>
</nav>

<section id="wrapper">
    <article class="post">
    <header>
        
            <h1>Node-FFI 不得不说的原理</h1>
        
        <h2 class="headline">May 15 2018
        
        </h2>
    </header>
</article>
<section id="post-body"><h3 id="Node-FFI-不得不数说的原理"><a href="#Node-FFI-不得不数说的原理" class="headerlink" title="Node-FFI 不得不数说的原理"></a>Node-FFI 不得不数说的原理</h3><blockquote>
<p>自己在实际开发中总结的东西</p>
</blockquote>
<a id="more"></a>
<h6 id="从计算机基础开始讲起"><a href="#从计算机基础开始讲起" class="headerlink" title="从计算机基础开始讲起"></a>从计算机基础开始讲起</h6><ul>
<li><p>线程, 进程, 协程</p>
<ul>
<li>线程: 操作系统能够进行运算调度的最小单位，包含在进程之中，是进程中的实际运作单位，顺序执行</li>
<li>进程: 程序的基本执行实体，包含 1 或多个线程</li>
<li>协程: 非操作系统调度，由用户手动调度切换上下文的程序组件</li>
<li>相关链接</li>
<li><ol>
<li><a href="https://zh.wikipedia.org/zh-hans/%E7%BA%BF%E7%A8%8B" target="_blank" rel="noopener">线程</a></li>
</ol>
</li>
<li><ol start="2">
<li><a href="https://github.com/libuv/libuv" target="_blank" rel="noopener">libuv</a></li>
</ol>
</li>
</ul>
</li>
<li><p>函数调用约定, 指针, (动态/静态)链接库</p>
<ul>
<li>指针: 所有数据类型都包含对应的指针类型，其内容是指向的变量的地址，函数本身就是编译后的一块内存，所以函数本身就是指针</li>
<li>函数调用约定: 不同CPU不同操作系统的底层实现中，调用一个函数都是靠操作栈来实现，但是不同的环对栈的顺序与存储的大小约定不同，这些约定称为函数调用约定</li>
<li><ol>
<li><a href="https://blog.csdn.net/fly2k5/article/details/544112" target="_blank" rel="noopener">函数调用约定</a></li>
</ol>
</li>
<li><a href="http://lucky521.github.io/blog/design/2016/07/14/dylib-staticlib.html" target="_blank" rel="noopener">链接库</a></li>
</ul>
</li>
<li><p>符号表</p>
<ul>
<li><a href="https://zh.wikipedia.org/wiki/%E7%AC%A6%E5%8F%B7%E8%A1%A8" target="_blank" rel="noopener">概念</a></li>
<li><a href="http://linuxtools-rst.readthedocs.io/zh_CN/latest/tool/nm.html" target="_blank" rel="noopener">如何查看</a></li>
</ul>
</li>
</ul>
<h6 id="回到-Node-js-的部分"><a href="#回到-Node-js-的部分" class="headerlink" title="回到 Node.js 的部分"></a>回到 Node.js 的部分</h6><ul>
<li><p>说说 V8</p>
<ul>
<li><a href="https://v8docs.nodesource.com/" target="_blank" rel="noopener">V8 Docs</a></li>
<li><a href="http://gitbook.cn/books/5938f4ae8b55d47644b7a445/index.html" target="_blank" rel="noopener">N-API</a></li>
<li>N-API 版本的 ffi 和 ref</li>
<li><ol>
<li><a href="https://github.com/node-ffi-napi/node-ffi-napi" target="_blank" rel="noopener">node-ffi-napi</a></li>
</ol>
</li>
<li><ol start="2">
<li><a href="https://github.com/node-ffi-napi/ref-napi" target="_blank" rel="noopener">ref-napi</a></li>
</ol>
</li>
</ul>
</li>
<li><p>Node native addon</p>
<ul>
<li>格式: 动态链接库</li>
<li>文件后缀: .node</li>
<li>区别: 入口函数不同</li>
<li>Demo:</li>
<li><ol>
<li><a href="https://github.com/springhack/SpringHack/blob/write/assets/node-ffi-demo/addon.cc" target="_blank" rel="noopener">Node binding demo</a></li>
</ol>
</li>
<li><ol start="2">
<li><a href="https://github.com/springhack/SpringHack/blob/write/assets/node-ffi-demo/calc.m" target="_blank" rel="noopener">FFI demo</a></li>
</ol>
</li>
<li><ol start="3">
<li><a href="https://gist.github.com/dmh2000/9519489" target="_blank" rel="noopener">Via uv_default_loop</a></li>
</ol>
</li>
<li><ol start="4">
<li><a href="https://github.com/springhack/SpringHack/blob/write/assets/node-ffi-demo/index.js" target="_blank" rel="noopener">JS Code</a></li>
</ol>
</li>
</ul>
</li>
</ul>
<blockquote>
<p>Demo 运行截图(N-API 为实验性特性所以会有一个警告):</p>
<p><img src="/images/demo.png" alt=""></p>
</blockquote>
<blockquote>
<p>其中第三种方案其实是借助 <code>libuv</code> 的接口实现，此前这种方式仅仅是因为</p>
<p>Node.js 使用了 <code>uv_default_loop</code>，不过在 N-API 中被官方支持了:</p>
<p><img src="/images/n-api-uv-loop.png" alt=""></p>
</blockquote>
<ul>
<li>Event Loop, GC<ul>
<li>简单来说: 一个分阶段的线程，通常我们称为 JS 主线程，V8 中使用 <code>uv_default_loop</code> 实现</li>
<li>GC: 即垃圾回收，垃圾回收是相对于我们编译器编译阶段可见的上下文为准的，即一个动态链接库的对象生命周期对调用它的程序不可见</li>
</ul>
</li>
</ul>
<h6 id="Node-FFI-令人兴奋的跳跃"><a href="#Node-FFI-令人兴奋的跳跃" class="headerlink" title="Node-FFI: 令人兴奋的跳跃"></a>Node-FFI: 令人兴奋的跳跃</h6><ol>
<li><p>从载入动态库说起</p>
<blockquote>
<p>a. 其实大部分编译型语言是具备载入动态库的能力的，因为操作系统已经提供了相关的封装，但是必须是编译前定义好被调用函数结构、函数调用规则等</p>
<p>b. 动态类型语言是运行在 VM 之上，而此时的 VM 已经是是编译过的二进制模块，已经不具备上文所说的特性</p>
</blockquote>
</li>
<li><p>libffi: Node-FFI 的核心</p>
<blockquote>
<p>a. 优势: 可以动态定义函数的调用方法，可以动态定绑定函数实体到指针</p>
<p>b. 应用: <code>OpenJDK, Dalvik, CPython</code> 等非常著名的引擎: <a href="http://sourceware.org/libffi/" target="_blank" rel="noopener">libffi</a></p>
<p>c. 实现:</p>
</blockquote>
</li>
</ol>
<table>
<thead>
<tr>
<th style="text-align:left">特性</th>
<th style="text-align:center">实现方式</th>
<th style="text-align:center">实现语言</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">定义函数</td>
<td style="text-align:center">通过定义 <code>ffi_cif</code> 结构体描述函数，并通过模拟函数调用方式实现调用</td>
<td style="text-align:center"><code>inline asm</code></td>
</tr>
<tr>
<td style="text-align:left">绑定函数</td>
<td style="text-align:center">通过定义 <code>ffi_closure</code> 绑定 <code>ffi_cif</code> 到指定函数并返回一个函数指针，当调用这个指针，指针指向的函数通过 <code>ffi_cif</code> 结构体的定义模拟取栈的操作并传入被绑定的函数</td>
<td style="text-align:center"><code>inline asm</code></td>
</tr>
</tbody>
</table>
<h6 id="Node-FFI-函数回调的实现"><a href="#Node-FFI-函数回调的实现" class="headerlink" title="Node-FFI: 函数回调的实现"></a>Node-FFI: 函数回调的实现</h6><ul>
<li><p>流程实现</p>
<ul>
<li>太长了，参见源码与我的讲解: <a href="https://github.com/springhack/node-ffi/blob/master/src/callback_info.cc" target="_blank" rel="noopener">callback_info.cc</a></li>
</ul>
</li>
<li><p>源码角度展开</p>
<ul>
<li><a href="https://github.com/springhack/node-ffi/blob/master/src/ffi.cc" target="_blank" rel="noopener">FFI_CALL</a></li>
<li><a href="https://github.com/springhack/node-ffi/blob/master/src/callback_info.cc" target="_blank" rel="noopener">FFI_CALLBACK</a></li>
</ul>
</li>
<li><p>回调的惊险跳跃: 多线程回调如何变成单线程 &amp;&amp; 如何 invoke 进入 JS EventLoop</p>
<ul>
<li><a href="https://github.com/springhack/node-ffi/blob/master/src/threaded_callback_invokation.cc" target="_blank" rel="noopener">CALLBACK_INVOKATION</a></li>
</ul>
</li>
</ul>
<h6 id="题外话"><a href="#题外话" class="headerlink" title="题外话"></a>题外话</h6><ul>
<li>让我想想再说…</li>
</ul>
</section>
    

    <footer id="post-meta" class="clearfix">
        <a href="/about/">
        <img class="avatar" src="/images/avatar.png">
        <div>
            <span class="dark">Dosk技术站</span>
            <span>SpringHack的无名技术小站</span>
        </div>
        </a>
        <section id="sharing">
            <a title="Share to Twitter" class="twitter" href="https://twitter.com/intent/tweet?text=https://www.dosk.win/2018/05/15/node-ffi/ - Node-FFI 不得不说的原理 @"><span class="icon-twitter">tweet</span></a>
            <a title="Share to Facebook" class="facebook" href="#" onclick="
                window.open(
                  'https://www.facebook.com/sharer/sharer.php?u='+encodeURIComponent(location.href),
                  'facebook-share-dialog',
                  'width=626,height=436');
                return false;"><span class="icon-facebook-sign">Share</span>
            </a>
        </section>
    </footer>


  <section id="comment">
    <button class="btn" id="loadcmts" onclick="cmts.load();">Load Comments</button>
    <div id="gitment"></div>
    <script src='/js/gitment.browser.js'></script>
    <link rel="stylesheet" href=''>
    <script>
      var cmts={
        load:function cmts(){
          var gitment = new Gitment({
          
            id: "Node-FFI 不得不说的原理",
          
            owner: "springhack",
            repo: "SpringHack",
            oauth: {
              client_id: "6c8cd45b9c7d253393be",
              client_secret: "ef45833d84aefdec5b79937d192eeadba3568a64",
            },
          })
          gitment.render('gitment');
          var loadcmt = document.getElementById("loadcmts");
          var imyourfather = loadcmt.parentNode;
          imyourfather.removeChild(loadcmts)
        }
      }
    </script>
  </section>


    
        <ul id="post-list" class="archive readmore">
        <h3>Read more</h3>
        
            <li>
    <aside class="dates">Nov 11 2018</aside>
    <a href="/2018/11/11/2018-11-12.00.01/">关于 exagear 的破解(其实是原理解析)</a>
    <h2></h2>
</li>
        
            <li>
    <aside class="dates">Nov 02 2018</aside>
    <a href="/2018/11/02/2018-11-03/">我又来立 flag 啦</a>
    <h2></h2>
</li>
        
            <li>
    <aside class="dates">May 15 2018</aside>
    <a href="/2018/05/15/node-ffi/">Node-FFI 不得不说的原理</a>
    <h2></h2>
</li>
        
            <li>
    <aside class="dates">Jan 01 2018</aside>
    <a href="/2018/01/01/2018first/">2018年首发</a>
    <h2></h2>
</li>
        
            <li>
    <aside class="dates">Aug 31 2017</aside>
    <a href="/2017/08/31/screencapture/">macOS下截图程序的开发</a>
    <h2></h2>
</li>
        
            <li>
    <aside class="dates">Aug 29 2017</aside>
    <a href="/2017/08/29/bike/">以后骑车上班</a>
    <h2></h2>
</li>
        
            <li>
    <aside class="dates">Jul 02 2017</aside>
    <a href="/2017/07/02/think/">毕业之后的人生计划</a>
    <h2></h2>
</li>
        
            <li>
    <aside class="dates">Apr 18 2017</aside>
    <a href="/2017/04/18/boot2env-update/">React 脚手架更新</a>
    <h2></h2>
</li>
        
            <li>
    <aside class="dates">Apr 09 2017</aside>
    <a href="/2017/04/09/bug-fixer/">做一个专职修 BUG 的码农</a>
    <h2></h2>
</li>
        
            <li>
    <aside class="dates">Mar 22 2017</aside>
    <a href="/2017/03/22/google-v8-function-call/">深入探究 JavaScript 的函数调用</a>
    <h2></h2>
</li>
        
        </ul>
    

	<footer id="footer">
	<div id="social">
		<p class="small">© Copyright 2018
			<a href="/"> SpringHack </a>/
			<a href="https://hexo.io"> Hexo </a>/
			<a href="https://github.com/caisiduo/hexo-theme-lightime"> Lightime</a>
		</p>
	</div>
</footer>
</section>

	<script src="//cdnjs.loli.net/ajax/libs/instantclick/3.0.1/instantclick.min.js" data-no-instant></script>
	<script data-no-instant>
		
			(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
			(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
			m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
			})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
			ga('create', 'UA-XXXXXXXX-Y', 'auto');
			ga('send', 'pageview');
  			InstantClick.on('change', function() {
  				ga('send', 'pageview', location.pathname + location.search);
			});
		
		InstantClick.init('mousedown');
	</script>



