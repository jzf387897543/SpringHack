<!doctype html>
<!--
  Author: SpringHack - springhack@live.cn
  Last modified: 2021-09-12 15:45:52
  Filename: admin/index.html
  Description: Created by SpringHack using vim automatically.
-->
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv='Content-Type' content='text/html; charset=utf-8'>
    <title>Dosk Admin</title>
  </head>
  <body>
    <script src="https://unpkg.com/netlify-cms@^2.0.0/dist/netlify-cms.js"></script>
    <script>
      // Inject github markdown css
      CMS.registerPreviewStyle('/admin/markdown.css');
      // Hook login phase
      let loginButton = null;
      let loginForm = null;
      let changed = false;
      let timer = null;
      let frame = null;
      document.addEventListener('click', (ev) => {
        // Ignore other click events
        if (ev
            && ev.target
            && ev.target.className
            && ev.target.className.includes
            && ev.target.className.includes('LoginButton')) {
          // Stop propagation right now
          ev.stopImmediatePropagation();
          if (changed) {
            return;
          }
          // Open window for auth
          const url = new URL(location.href);
          const frame = document.createElement('iframe');
          frame.src = './passport.html';
          frame.className = 'passport-frame';
          frame.referrerPolicy = 'no-referrer';
          document.body.appendChild(frame);
          window.addEventListener('message', (event) => {
            if (event.data && event.data.type === 'passport') {
              const { token } = event.data;
              const netlifyCmsUser = {
                token,
                backendName: 'github'
              };
              localStorage.setItem('netlify-cms-user', JSON.stringify(netlifyCmsUser));
              location.reload();
            }
          });
        }
        // Oops...
        return;
      }, true);
      document.addEventListener('mousedown', (ev) => {
        if (ev
            && ev.target
            && ev.target.className
            && ev.target.className.includes
            && ev.target.className.includes('LoginButton')) {
          timer = setTimeout(() => {
            changed = true;
            // Exchange UI
            loginButton = ev.target;
            loginButton.style.visibility = 'hidden';
            loginForm = document.createElement('form');
            loginButton.parentElement.insertBefore(loginForm, loginButton);
            // Token input element
            let input = document.createElement('input');
            input.autocomplete = 'current-password';
            input.placeholder = 'wtf does the fuck say';
            input.autofocus = true;
            input.type = 'password';
            input.addEventListener('keydown', (ev) => {
              if (ev.key === 'Enter') {
                const token = input.value;
                const netlifyCmsUser = {
                  token,
                  backendName: 'github'
                };
                localStorage.setItem('netlify-cms-user', JSON.stringify(netlifyCmsUser));
                location.reload();
              }
            });
            input.style.width = '300px';
            input.style.padding = '7px';
            input.style.fontSize = '15px';
            input.style.textAlign = 'center';
            input.style.borderRadius = '20px';
            loginForm.appendChild(input);
            input.focus();
            // Login form
            loginForm.style.top = '-38px';
            loginForm.style.height = '0px';
            loginForm.style.position = 'relative';
          }, 2000);
        }
      }, true);
      document.addEventListener('mouseup', (ev) => {
        clearTimeout(timer);
        // Ignore other click events
        if (changed
            && ev
            && ev.target
            && ev.target.className
            && ev.target.className.includes
            && ev.target.className.includes('LoginButton')) {
          // Stop propagation right now
          ev.stopImmediatePropagation();
        }
        // Oops...
        return;
      }, true);
    </script>
    <style>
      .passport-frame {
        background: white;
        position: fixed;
        width: 400px;
        height: 400px;
        left: 0;
        top: calc(50vh - 200px);
        margin: 0 auto;
        right: 0;
        border-radius: 10px;
        border: 0;
        box-shadow: 0 0 20px 0px;
      }
    </style>
  </body>
</html>
